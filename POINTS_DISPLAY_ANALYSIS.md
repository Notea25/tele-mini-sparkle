# Анализ проблемы с отображением очков

## Симптомы

### Главный лидерборд
- **Отображается:** 30
- **Ожидается:** -30
- **Разница:** Знак (положительное vs отрицательное)

### Клубный лидерборд
- **Отображается:** -42
- **Ожидается:** -30
- **Разница:** -12 очков (вероятно штрафы следующего тура)

---

## Гипотезы

### Гипотеза 1: Бэкенд изменился
**Старая схема (согласно документации):**
```json
{
  "total_points": 135,  // total_earned (БРУТТО, без вычета штрафов)
  "total_penalty_points": 12
}
```
**Фронтенд отображал:** `total_points` (брутто) = 135

**Новая схема (предположение):**
```json
{
  "total_points": -30,  // total_net (ЧИСТЫЕ очки, уже с вычетом штрафов)
  "total_penalty_points": 12
}
```
**Фронтенд отображает:** `total_points` (чистые) = -30 ❌ Но показывает 30

### Гипотеза 2: Проблема с модулем числа
Фронтенд где-то использует `Math.abs(total_points)`:
```typescript
// Где-то в коде
{Math.abs(row.totalPoints).toLocaleString()}  // 30 вместо -30
```

### Гипотеза 3: Штрафы следующего тура
В клубном лидерборде `total_penalty_points` включает:
- Финализированные туры: -30
- Текущий/следующий тур: -12
- **Итого:** -42

---

## Текущий код

### League.tsx (строка 691)
```typescript
{row.totalPoints.toLocaleString()}
```

### Обработка данных
```typescript
const tableData = useMemo(() => {
  // ...
  const top3 = leaderboard.slice(0, 3).map((entry: LeaderboardEntry) => ({
    totalPoints: entry.total_points,
    totalPenaltyPoints: entry.total_penalty_points || 0,
  }));
});
```

---

## Возможные решения

### Решение 1: Убрать Math.abs (если он есть)
Если где-то используется модуль числа, убрать его.

### Решение 2: Отображать total_net явно
Если бэкенд вернёт новое поле:
```typescript
{row.totalNet.toLocaleString()}
```

### Решение 3: Использовать только финализированные штрафы
Если проблема в штрафах следующего тура, нужно изменить бэкенд, чтобы:
```python
# Считать только финализированные туры
total_penalty = SUM(penalty_points) WHERE is_finalized = True
```

### Решение 4: Не вычитать штрафы (если total_points уже чистые)
Текущий код правильный, если `total_points` уже содержит чистые очки:
```typescript
{row.totalPoints.toLocaleString()}  // Уже чистые очки
```

---

## Проверка

Нужно узнать точные значения с бэкенда:
1. `tour_points` =?
2. `total_points` =?
3. `penalty_points` =?
4. `total_penalty_points` =?

Тогда станет понятно, какая гипотеза верна.
