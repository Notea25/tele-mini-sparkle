# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ total_penalty_points –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

**–î–∞—Ç–∞:** 1 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìä –ü—Ä–æ–±–ª–µ–º–∞

`total_penalty_points` –≤–∫–ª—é—á–∞–ª —à—Ç—Ä–∞—Ñ—ã **—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—É—Ä–∞** (is_finalized = False), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ –æ–±—â–µ–π —Å—É–º–º–µ —à—Ç—Ä–∞—Ñ–æ–≤.

### –ü—Ä–∏–º–µ—Ä
- –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã: –®—Ç—Ä–∞—Ñ—ã = -30
- –°–ª–µ–¥—É—é—â–∏–π —Ç—É—Ä (–Ω–µ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω): –®—Ç—Ä–∞—Ñ—ã = -12
- **–û—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å:** -42 ‚ùå
- **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:** -30 ‚úÖ

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

### –§–∞–π–ª
`sporttg/app/squads/services.py`

### –ú–µ—Ç–æ–¥
`calculate_squad_points_bulk` (—Å—Ç—Ä–æ–∫–∏ 812-825)

### –ë—ã–ª–æ
```python
total_stmt = (
    select(
        SquadTour.squad_id,
        func.sum(SquadTour.points).label("total_earned"),
        func.sum(SquadTour.penalty_points).label("total_penalty")
    )
    .where(SquadTour.squad_id.in_(squad_ids))
    .group_by(SquadTour.squad_id)
)
```

### –°—Ç–∞–ª–æ
```python
total_stmt = (
    select(
        SquadTour.squad_id,
        func.sum(SquadTour.points).label("total_earned"),
        func.sum(SquadTour.penalty_points).label("total_penalty")
    )
    .where(
        SquadTour.squad_id.in_(squad_ids),
        SquadTour.is_finalized == True  # ‚úÖ –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã
    )
    .group_by(SquadTour.squad_id)
)
```

---

## üéØ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `calculate_squad_points_bulk`:

1. ‚úÖ **–ì–ª–∞–≤–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥**  
   `GET /api/squads/leaderboard/{tour_id}`

2. ‚úÖ **–ö–ª—É–±–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥**  
   `GET /api/squads/leaderboard/{tour_id}/by-fav-team/{fav_team_id}`

3. ‚úÖ **–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ª–∏–≥–∏**  
   `GET /api/commercial_leagues/{commercial_league_id}/leaderboard/{tour_id}`

4. ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ª–∏–≥–∏**  
   `GET /api/user_leagues/{user_league_id}/leaderboard/{tour_id}`

---

## üìù –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```json
{
  "total_points": 30,           // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
  "total_penalty_points": 42,   // 30 (—Ñ–∏–Ω.) + 12 (—Å–ª–µ–¥. —Ç—É—Ä) ‚ùå
  "tour_points": -8
}
```
–ß–∏—Å—Ç—ã–µ –æ—á–∫–∏: `30 - 42 = -12` ‚ùå (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```json
{
  "total_points": 30,           // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
  "total_penalty_points": 30,   // –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã ‚úÖ
  "tour_points": -8
}
```
–ß–∏—Å—Ç—ã–µ –æ—á–∫–∏: `30 - 30 = 0` ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

---

## üöÄ –ö–æ–º–º–∏—Ç (Backend)

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** `sporttg`  
**–ö–æ–º–º–∏—Ç:** `3d4ccb6`  
**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
Fix: Exclude next tour penalties from total_penalty_points

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ total_penalty_points –≤ calculate_squad_points_bulk.
–¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã (is_finalized = True),
—á—Ç–æ–±—ã —à—Ç—Ä–∞—Ñ—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—É—Ä–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –æ–±—â—É—é —Å—É–º–º—É.
```

**–ó–∞–ø—É—à–µ–Ω–æ:** ‚úÖ `origin/main`

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –±—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ `total_penalty_points`, –º–æ–∂–Ω–æ **—É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–∫—Å—ã** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ–º–º–∏—Ç–µ `694f24b`.

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∫–æ–¥

–ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ `total_penalty_points` –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ç—É—Ä, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å—Ç–æ–º—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é:

```typescript
// –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç total_net –Ω–∞–ø—Ä—è–º—É—é –≤ –±—É–¥—É—â–µ–º
{row.totalPoints.toLocaleString()}

// –ò–ª–∏ –≤—ã—á–∏—Å–ª—è—Ç—å —á–∏—Å—Ç—ã–µ –æ—á–∫–∏ (–µ—Å–ª–∏ total_points = gross)
{(row.totalPoints - row.totalPenaltyPoints).toLocaleString()}
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ì–ª–∞–≤–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ ‚Äî —à—Ç—Ä–∞—Ñ—ã —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤
2. –ö–ª—É–±–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ ‚Äî —à—Ç—Ä–∞—Ñ—ã —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤
3. –í—Å–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ `total_penalty_points`
